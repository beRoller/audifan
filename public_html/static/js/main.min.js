!function(e,t,i){function n(){return e("body").hasClass("logged-in")}function o(t,i,n){e.ajax({method:t,data:i,success:n,cache:!1,dataType:"json"})}function a(t,i,n,o){var a=i||{};a.do=t,e.ajax({url:"/ajax/",method:"POST",data:a,success:n,complete:o,error:function(e,t,i){console.log("AJAX Error: ",t,i)},cache:!1,dataType:"json"})}e.confirmModal=function(t){var i,n,o;o=function(t){e("#confirm-modal").off("hide.bs.modal",i),e("#confirm-modal .modal-confirm").off("click",n)},i=function(e){console.log("cancel"),t.cancelCallback&&t.cancelCallback(e),o(e)},n=function(i){console.log("confirm"),t.closeOnConfirm&&e("#confirm-modal").modal("hide"),t.confirmCallback&&t.confirmCallback(i),o(i)},e("#confirm-modal .modal-title").html(t.title||""),e("#confirm-modal .modal-body").html(t.message||""),e("#confirm-modal .modal-cancel").html(t.cancel||"Cancel"),e("#confirm-modal .modal-confirm").html(t.confirm||"OK").on("click",n),e("#confirm-modal").on("hide.bs.modal",i),e("#confirm-modal").modal()};var s=t.View.extend({userBarContent:!1,fb:!1,initialize:function(){this.userBarContent=this.$el.find(".userbarcontent");var e=this;window.fbAsyncInit=function(){FB.init({appId:"localhost"===window.location.hostname?"545000688871283":"366262623446900",channelUrl:"//"+window.location.hostname+"/static/channel.html",status:!0,cookie:!0,xfbml:!0}),e.fb=!0},function(e){var t,i="facebook-jssdk",n=e.getElementsByTagName("script")[0];e.getElementById(i)||(t=e.createElement("script"),t.id=i,t.async=!0,t.src="//connect.facebook.net/en_US/all.js",n.parentNode.insertBefore(t,n))}(document)},toggleMobileLogin:function(){this.userBarContent.toggleClass("mobile-login-visible")},events:{"click #mobile-login-toggle":function(e){return this.toggleMobileLogin(),e.preventDefault(),!1},"click .login-cancel-link":function(e){return this.toggleMobileLogin(),e.preventDefault(),!1},"click #facebooklogin":function(e){return this.fb&&FB.login(function(e){if(e.authResponse){var t="/account/fbconnect/?accessToken="+e.authResponse.accessToken;window.location.pathname&&(t+="&thru="+window.location.pathname),window.location=t}},{}),e.preventDefault(),!1},"click #mobile-menu-toggle":function(e){var t=this.$el.find(".mobile-links"),i=this.$el.find("#mobile-menu-toggle .glyphicon"),n=t.is(":visible")?"down":"up";return i.removeClass().addClass("glyphicon glyphicon-chevron-"+n),t.slideToggle("fast"),e.preventDefault(),!1}}});new s({el:document.getElementById("userbar")});var r=t.View.extend({remaining:0,completeString:!1,completeFunc:!1,interval:!1,initialize:function(e){e.seconds&&(this.remaining=e.seconds),e.completeString&&(this.completeString=e.completeString),e.completeFunction&&window[e.completeFunction]&&(this.completeFunc=window[e.completeFunction]),this.startInterval(),this.tick()},startInterval:function(){var e=this;this.interval=setInterval(function(){e.tick()},1e3)},setRemaining:function(e){this.remaining=e},render:function(){var t="";if(this.remaining<=0)this.completeFunc?this.completeFunc():t=this.completeString?this.completeString:"0:00:00";else{var i=this.remaining,n=Math.floor(i/3600);i-=3600*n;var o=Math.floor(i/60);i-=60*o,t+=n<10?"0"+n:n,t+=":",t+=o<10?"0"+o:o,t+=":",t+=i<10?"0"+i:i}e(this.el).html(t)},tick:function(){this.remaining--,this.remaining<=0&&this.interval&&(clearInterval(this.interval),this.interval=!1),this.render()}});e("[data-countdown]").each(function(t){var i=e(this),n=new r({el:this,seconds:i.data("countdown"),completeString:i.data("countdown-complete-string"),completeFunction:i.data("countdown-complete-function")});i.data("countdown-view",n)});var l=t.View.extend({group:!1,type:!1,timeRemaining:0,startContainer:!1,secretContainer:!1,stopContainer:!1,timeDisplay:!1,initialize:function(e){console.log("initialize timer");this.group=e.group,this.type=this.$el.data("type"),this.startContainer=this.$el.find(".timerstart"),this.secretContainer=this.$el.find(".timersecretstart"),this.stopContainer=this.$el.find(".timerstop"),this.timeDisplay=this.$el.find(".timerdisplay")},getFormattedTimeRemaining:function(){var e=this.timeRemaining%3600,t=Math.floor(this.timeRemaining/3600),i=Math.floor(e/60),n=e%60;return t+":"+(i<10?"0"+i:i)+":"+(n<10?"0"+n:n)},showSecretPrompt:function(){this.hideAllControls(),this.secretContainer.show()},start:function(){this.hideAllControls(),this.group.mainView.send(this.type,{timer:this.group.id})},stop:function(){this.hideAllControls(),this.group.mainView.send(this.type,{timer:this.group.id,stop:!0})},hideAllControls:function(){this.startContainer.hide(),this.secretContainer.hide(),this.stopContainer.hide()},updateControls:function(){this.hideAllControls(),this.timeRemaining>0?this.stopContainer.show():this.startContainer.show()},render:function(){this.timeDisplay.html(this.getFormattedTimeRemaining())},events:{"click .timerstart":function(){"water"==this.type||"dust"==this.type?this.showSecretPrompt():this.start()},"click .timerstop":function(){this.stop()},"click .secretcancelbutton":function(){this.updateControls()}}}),c=t.View.extend({mainView:!1,id:!1,timersByType:!1,initialize:function(t){console.log("initialize timer group");var i=this;this.mainView=t.mainView,this.id=this.$el.data("id"),this.timersByType={},this.$el.find(".timerlabel").each(function(){var t=new l({el:e(this),group:i});i.timersByType[t.type]=t})},render:function(){for(var e in this.timersByType)this.timersByType[e].render()},events:{".timername a":function(e){return this.$el.addClass("edit-name"),e.preventDefault(),!1}}}),d=t.View.extend({groupsById:{},startTime:!1,totalSeconds:0,message:!1,initialize:function(t){console.log("initialize main view");var i=this;this.message=this.$el.find("#timermessage"),this.$el.find("#timers .timercontainer").each(function(){var t=new c({el:e(this),mainView:i});i.groupsById[t.id]=t}),this.send("get",{},function(e){this.response(e),this.startTime=new Date,window.requestAnimationFrame(this.render.bind(this)),i.setMessage("")}.bind(this))},send:function(t,i,n){var o=this,a=i||{};a.action=t,e.ajax({data:a,dataType:"json",success:n||this.response.bind(this),error:function(e,t,i){o.setMessage('Something went wrong while trying to connect to the server.  Please try <a href="/community/gardentimer/">reloading</a>.')}})},updateTimerData:function(e){},response:function(e){if(console.log("response: ",e),e.timers)for(var t in e.timers){var i=e.timers[t],n=this.groupsById[i.id];if(n)for(var o in n.timersByType)n.timersByType[o].timeRemaining=i[o]?i[o]:0,n.timersByType[o].updateControls()}},setMessage:function(e){this.message.html(e),e?this.message.slideDown("fast"):this.message.slideUp("fast")},eachTimer:function(e){for(var t in this.groupsById)for(var i in this.groupsById[t].timersByType)e.call(this,this.groupsById[t].timersByType[i])},render:function(){var e=Math.floor(((new Date).getTime()-this.startTime.getTime())/1e3);if(e!=this.totalSeconds){var t=e-this.totalSeconds;this.eachTimer(function(e){e.timeRemaining>0&&(e.timeRemaining-t<=0?e.timeRemaining=0:e.timeRemaining-=t)}),this.totalSeconds=e;for(var i in this.groupsById)this.groupsById[i].render()}window.requestAnimationFrame(this.render.bind(this))},events:{}});1===e(".garden-timer-container").length&&new d({el:e(".garden-timer-container")});var h=t.View.extend({id:null,added:!1,waiting:!1,favorite:null,link:null,initialize:function(){this.id=this.$el.data("song-id"),this.favorite=this.$el.find(".favorite"),this.link=this.$el.find(".favorite a"),this.added="Remove"===this.link.html()},addOrRemove:function(){console.log("addorremove",this.id,this.added);var e=this;this.waiting||(this.waiting=!0,this.favorite.html('<i class="fa fa-spin fa-spinner"></i>'),o("GET",{favorite:this.id},function(){e.added?(e.favorite.html('<a href="#">Add</a>'),e.added=!1):(e.favorite.html('<a href="#">Remove</a>'),e.added=!0),e.waiting=!1}))},events:{"click .favorite a":function(e){return this.addOrRemove(),e.preventDefault(),!1}}});n()&&e("tr[data-song-id]").each(function(e){new h({el:this})});var p=t.View.extend({prizeTexts:{prize_3:"You won a -10% Cooldown Item!<br />Time between Happy Box spins reduced by 10%.<br /><br />Lasts 7 days.<br />If you already owned this item, the time has been extended by 7 days.<br /><br />Congrats!",prize_4:"You won a -25% Cooldown Item!<br />Time between Happy Box spins reduced by 25%.<br /><br />Lasts 7 days.<br />If you already owned this item, the time has been extended by 7 days.<br /><br />Congrats!",prize_5:"You won a -40% Cooldown Item!<br />Time between Happy Box spins reduced by 40%.<br /><br />Lasts 7 days.<br />If you already owned this item, the time has been extended by 7 days.<br /><br />Congrats!",prize_11:"You won a Megaphone ticket!<br /><br />Use it by clicking the Megaphone link at the top of any page.<br /><br />Congrats!",prize_12:"You won a Badge!<br /><br />Choose your new badge on the My Stuff page.<br /><br />You have 2 weeks to redeem your badge or it will disappear.<br /><br />Congrats!",prize_15:"You won a VIP Drawing Entry!<br /><br />An additional entry has been added for the drawing at the end of the month.<br /><br />Congrats!",prize_31:'You won a Coin Box!<br /><br />Open it on the <a href="/account/stuff/" target="_blank">My Stuff</a> page.<br /><br />You have 2 weeks to open it or it will disappear.<br /><br />Congrats!',prize_32:'You won a Double Coin Box!<br /><br />Open it on the <a href="/account/stuff/" target="_blank">My Stuff</a> page.<br /><br />You have 2 weeks to open it or it will disappear.<br /><br />Congrats!',prize_33:'You won a Triple Coin Box!<br /><br />Open it on the <a href="/account/stuff/" target="_blank">My Stuff</a> page.<br /><br />You have 2 weeks to open it or it will disappear.<br /><br />Congrats!',prize_34:"You won a +5% Coin Item!<br />Increases coin gains from all sources by 5%.<br /><br />Lasts 7 days.<br />If you already owned this item, the time has been extended by 7 days.<br /><br />Congrats!",prize_35:"You won a +15% Coin Item!<br />Increases coin gains from all sources by 15%.<br /><br />Lasts 7 days.<br />If you already owned this item, the time has been extended by 7 days.<br /><br />Congrats!",prize_36:"You won a +25% Coin Item!<br />Increases coin gains from all sources by 25%.<br /><br />Lasts 7 days.<br />If you already owned this item, the time has been extended by 7 days.<br /><br />Congrats!",prize_37:'You won a Mystery Coin Box!<br /><br />Open it on the <a href="/account/stuff/" target="_blank">My Stuff</a> page.<br /><br />You have 2 weeks to open it or it will disappear.<br /><br />Congrats!',"prize_-1":"You didn't win anything,<br />but you have received {data1} coins!<br /><br />Congrats!<br /><br /><br />{data1} coins have also been added to the Jackpot!","prize_-2":"JACKPOT!!<br /><br />You won {data1} coins!<br /><br />Congrats!"},spinFuncInterval:!1,cdFuncInterval:!1,prizeTextContainer:null,prizeText:null,goButton:null,ballSpin:null,nextSpinTime:null,audio:null,initialize:function(){this.prizeTextContainer=this.$el.find("#happyboxprizetextcontainer"),this.prizeText=this.$el.find("#happyboxprizetext"),this.goButton=this.$el.find("#happyboxgo"),this.ballSpin=this.$el.find("#happyboxballspin"),this.nextSpinTime=this.$el.find("#happyboxnextspintime"),this.audio=this.$el.find("#happyboxaudio")[0],setInterval(this.flashAnimation.bind(this),75)},flashAnimation:function(){this.$el.toggleClass("baseflash")},spinFunc:function(){var t=e(".happyboxballspinanimate");if(t.length>0){var i=8,n=t.data("frame")||1,o=n===i?1:n+1;t=t.removeClass().addClass("happyboxballspinanimate happyboxballspinframe"+o),t.data("frame",o)}},cdFunc:function(){},requestSpin:function(){var e=this;o("GET",{spin:"spin"},function(t){e.spinFuncInterval&&(clearInterval(e.spinFuncInterval),e.ballSpin.removeClass().addClass("happyboxballspinstatic"),e.spinFuncInterval=!1);var i="Spin failed!<br />It may not be time to spin yet.";e.prizeTexts[t.resp]&&(i=e.prizeTexts[t.resp].replace(/\{data1\}/g,t.data1)),e.prizeText.html(i),e.prizeTextContainer.fadeIn("fast"),"prize_-1"===t.resp||"prize_-2"===t.resp;var n=e.nextSpinTime.data("countdown-view");n.setRemaining(t.sec),n.startInterval()})},events:{"click .happyboxgoavailable":function(){var e=this;this.prizeTextContainer.fadeOut("fast"),this.goButton.removeClass().addClass("happyboxgounavailable"),this.ballSpin.removeClass().addClass("happyboxballspinanimate"),this.spinFuncInterval=setInterval(function(){e.spinFunc()},100),e.spinFunc(),this.audio.play(),setTimeout(function(){e.requestSpin()},3e3)}}});n()&&new p({el:e("#happybox")}),e("#jump-to-top").click(function(t){return console.log("click"),e("body, html").animate({scrollTop:0},"fast"),t.preventDefault(),!1});var u=t.View.extend({initialize:function(){},isPopupOpen:function(){return this.$el.hasClass("open")},openPopup:function(){this.$el.addClass("open")},closePopup:function(){this.$el.removeClass("open")},togglePopup:function(){this.isPopupOpen()?this.closePopup():this.openPopup()},events:{"click #notification-button":function(e){this.togglePopup()},"click .popup-close":function(e){this.closePopup()},"click .notification-list-item-delete":function(t){var i=e(t.currentTarget).closest(".notification-list-item"),n=i.data("dbid");e(t.currentTarget).find("i").removeClass().addClass("fa fa-spinner fa-spin"),console.log(n),n&&a("notification-delete",{id:n},function(e){i.slideUp("fast",function(){i.remove()}),console.log(e)})}}});new u({el:e("#notification-container")});var m=t.View.extend({initialize:function(){},events:{"click .cancel-change":function(t){e(t.currentTarget).closest(".panel").removeClass("edit")}}});e(".my-account").length&&new m({el:e(".my-account")}),function(){e(".comment-container .usercardexpand").click(function(){e(this).closest(".usercardcontainer").toggleClass("open")})}()}(jQuery,Backbone,_);